<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Group AI Chat</title>
    <script src="/socket.io/socket.io.js"></script>
    <script src="/dist/ai-chat-widget.iife.js"></script>
    <style>
        /*ai-chat-widget { display: none !important; }
        */
        #custom-ui { max-width: 600px; margin: 20px auto; font-family: sans-serif; }
        
        /* Header / Settings */
        .controls { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; background: #f4f4f4; padding: 10px; border-radius: 8px; }
        #username-input { padding: 5px; border-radius: 4px; border: 1px solid #ccc; flex: 1; }
        
        #chat-window { height: 400px; border: 1px solid #ddd; overflow-y: auto; padding: 15px; background: #fff; border-radius: 8px; display: flex; flex-direction: column; }
        
        /* Chat Bubbles */
        .msg { margin-bottom: 12px; max-width: 80%; padding: 8px 12px; border-radius: 12px; position: relative; }
        .user-msg { align-self: flex-end; background: #007bff; color: white; border-bottom-right-radius: 2px; }
        .bot-msg { align-self: flex-start; background: #e9e9eb; color: #333; border-bottom-left-radius: 2px; }
        .sender-tag { font-size: 10px; font-weight: bold; margin-bottom: 2px; display: block; opacity: 0.8; }
    </style>
</head>
<body>

<div id="custom-ui">
    <div class="controls">
        <input type="text" id="username-input" placeholder="Enter Username..." value="Guest">
        <label style="font-size: 13px; font-weight: bold; cursor: pointer;">
            <input type="checkbox" id="ai-toggle"> Ask AI?
        </label>
    </div>

    <div id="chat-window"></div>
    
    <div style="display: flex; gap: 10px; margin-top: 10px;">
        <input type="file" id="file-input" style="font-size: 12px;">
        <input type="text" id="user-input" style="flex: 1; padding: 10px;" placeholder="Write a message...">
        <button onclick="sendMessage()" style="padding: 10px 20px; cursor: pointer;">Send</button>
    </div>
</div>

<ai-chat-widget id="bridge" api-key="AIzaSyC2hTqGOAauPjAfH5pgy-SzsgjF6JSsOIo" use-markdown="true"></ai-chat-widget>

<script>
    const socket = io();
    const bridge = document.getElementById('bridge');
    const chatWindow = document.getElementById('chat-window');
    const usernameInput = document.getElementById('username-input');
    const aiToggle = document.getElementById('ai-toggle');
    
    // index.html - Inside <script>
    let isSyncingFromRemote = false;

    // 1. Receiving from others: isLocal is NOT added
    socket.on('new-remote-message', (newMessage) => {
        isSyncingFromRemote = true; 
        bridge.pushHistory([...bridge.history, newMessage]);
    });

    usernameInput.addEventListener('input', (e) => {
        bridge.userName = e.target.value; // Syncs to React immediately
    });

    // 2. Sending locally: tag with isLocal
    async function sendMessage() {
        const inputField = document.getElementById('user-input');
        const fileInput = document.getElementById('file-input');
        const text = inputField.value.trim();
        const files = fileInput.files;

        if (!text && files.length === 0) return;

        // Process files
        const fileParts = await Promise.all(
            Array.from(files).map(file => readFileAsBase64(file))
        );

        // Build parts array: Files first, then the user's text prompt
        const parts = [...fileParts];
        if (text) {
            parts.push({ text: `${usernameInput.value}: ${text}` });
        } else {
            parts.push({ text: `${usernameInput.value}: Analyze these files.` });
        }

        const newMessage = { 
            role: 'user', 
            parts: parts,
            isLocal: true // Triggers AI in App.jsx
        };

        isSyncingFromRemote = false; 
        bridge.pushHistory([...bridge.history, newMessage]);
        
        inputField.value = '';
        fileInput.value = ''; // Reset file input
    }

    bridge.addEventListener('history-updated', (e) => {
        const history = e.detail;
        const lastMsg = history[history.length - 1];

        if (!isSyncingFromRemote && lastMsg) {
            // We strip isLocal before sending to the server
            const { isLocal, ...broadcastMsg } = lastMsg;
            socket.emit('message-sent', broadcastMsg);
        }
        isSyncingFromRemote = false;
        renderHistory(history); 
    });

    bridge.onQuery = () => {
        return aiToggle.checked; // Returns true/false to App.jsx
    };

    function setAiPersonality(type) {
        if (type === 'pirate') {
            bridge.aiContext = "You are a pirate. Speak in pirate slang and be grumpy.";
        } else if (type === 'scientist') {
            bridge.aiContext = "You are a formal scientist. Give detailed, technical group chat answers.";
        } else {
            bridge.aiContext = "You are a helpful group chat assistant.";
        }
    }

    // setAiPersonality('pirate');

    function renderHistory(history) {
        if (!history) return;
        chatWindow.innerHTML = history.map(msg => {
            const isBot = msg.role === 'model';
            const isMyMessage = msg.isLocal === true && !isBot;
            
            // FIX: Find the text part anywhere in the parts array
            const textPart = msg.parts.find(p => p.text);
            const rawText = textPart ? textPart.text : "";
            
            // Check if there is file data in the parts
            const hasFile = msg.parts.some(p => p.inline_data);
            
            let name = isBot ? "Gemini" : "User";
            let cleanText = rawText;

            if (!isBot && rawText.includes(': ')) {
                const parts = rawText.split(': ');
                name = parts[0];
                cleanText = parts.slice(1).join(': ');
            }

            return `
                <div class="msg ${isMyMessage ? 'user-msg' : 'bot-msg'}">
                    <span class="sender-tag">${name.toUpperCase()}</span>
                    ${hasFile ? `<div style="font-size: 10px; opacity: 0.7; margin-bottom: 4px;">ðŸ“Ž File Attached</div>` : ''}
                    <div class="bubble">${isBot ? bridge.parse(cleanText) : cleanText}</div>
                </div>
            `;
        }).join('');
        chatWindow.scrollTop = chatWindow.scrollHeight;
    }

    function readFileAsBase64(file) {
        return new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve({
                inline_data: {
                    mime_type: file.type || "text/plain",
                    data: reader.result.split(',')[1] 
                }
            });
            reader.onerror = reject;
            reader.readAsDataURL(file);
        });
    }
</script>
</body>
</html>